generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Certification {
  id          String    @id
  name        String
  issuer      String
  issuedAt    DateTime
  expiresAt   DateTime?
  documentUrl String?
  companyId   String
  Company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Company {
  id            String          @id
  name          String
  kvkNumber     String?         @unique
  type          CompanyType
  verified      Boolean         @default(false)
  verifiedAt    DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  email         String?
  phone         String?
  address       String?
  postcode      String?
  city          String?
  Certification Certification[]
  Project       Project[]
  User          User[]
  WhatsAppNumber         WhatsAppNumber[]
  NotificationPreference NotificationPreference[]
  TeamMember             TeamMember[]
}

model CostBreakdown {
  id          String       @id
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  category    CostCategory
  description String?
  budgeted    Decimal
  actual      Decimal      @default(0)
  propertyId  String
  Property    Property     @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, category])
  @@index([propertyId])
}

model Document {
  id              String         @id
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  name            String
  description     String?
  type            DocumentType
  mimeType        String
  fileSize        Int
  fileUrl         String
  documentDate    DateTime?
  expiresAt       DateTime?
  verified        Boolean        @default(false)
  verifiedBy      String?
  extractedData   Json?
  propertyId      String?
  projectId       String?
  phaseId         String?
  timelineEventId String?
  uploadedById    String
  source          DocumentSource @default(MANUAL)
  ProjectPhase    ProjectPhase?  @relation(fields: [phaseId], references: [id])
  Project         Project?       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  Property        Property?      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  TimelineEvent   TimelineEvent? @relation(fields: [timelineEventId], references: [id])
  User            User           @relation(fields: [uploadedById], references: [id])
  WhatsAppMessage WhatsAppMessage[]
  Issue           Issue[]
  VoiceNote       VoiceNote[]

  @@index([projectId])
  @@index([propertyId])
  @@index([type])
}

model MaintenanceRecord {
  id             String              @id
  createdAt      DateTime            @default(now())
  updatedAt      DateTime
  title          String
  description    String?
  category       MaintenanceCategory
  performedAt    DateTime?
  scheduledFor   DateTime?
  nextDueDate    DateTime?
  intervalMonths Int?
  performedBy    String?
  cost           Decimal?
  status         MaintenanceStatus   @default(SCHEDULED)
  propertyId     String
  Property       Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([nextDueDate])
  @@index([propertyId])
}

model MaterialUsage {
  id              String           @id
  createdAt       DateTime         @default(now())
  category        MaterialCategory
  name            String
  brand           String?
  productCode     String?
  color           String?
  quantity        Decimal?
  unit            String?
  batchNumber     String?
  appliedAt       DateTime?
  appliedBy       String?
  location        String?
  specSheetUrl    String?
  warrantyUrl     String?
  warrantyExpires DateTime?
  projectId       String
  Project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([projectId])
}

model Project {
  id                String              @id
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  name              String
  description       String?
  type              ProjectType
  status            ProjectStatus       @default(PLANNING)
  plannedStart      DateTime?
  plannedEnd        DateTime?
  actualStart       DateTime?
  actualEnd         DateTime?
  estimatedCost     Decimal?
  actualCost        Decimal?
  wkbRequired       Boolean             @default(false)
  wkbDossierId      String?
  propertyId        String
  companyId         String
  Document          Document[]
  MaterialUsage     MaterialUsage[]
  Company           Company             @relation(fields: [companyId], references: [id])
  Property          Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  ProjectContractor ProjectContractor[]
  ProjectPhase      ProjectPhase[]
  TimelineEvent     TimelineEvent[]
  WhatsAppNumber         WhatsAppNumber[]
  WhatsAppMessage        WhatsAppMessage[]
  NotificationPreference NotificationPreference[]
  Issue                  Issue[]
  VoiceNote              VoiceNote[]

  @@index([companyId])
  @@index([propertyId])
  @@index([status])
}

model ProjectContractor {
  id          String    @id
  role        String
  startDate   DateTime?
  endDate     DateTime?
  projectId   String
  companyId   String?
  companyName String?
  contactInfo String?
  Project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ProjectPhase {
  id           String      @id
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  name         String
  description  String?
  order        Int
  status       PhaseStatus @default(PENDING)
  plannedStart DateTime?
  plannedEnd   DateTime?
  actualStart  DateTime?
  actualEnd    DateTime?
  projectId    String
  Document     Document[]
  Project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Property {
  id                 String              @id
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  name               String?
  street             String?
  houseNumber        String?
  houseNumberAdd     String?
  postcode           String?
  city               String
  country            String              @default("NL")
  kavelNumber        String?
  projectName        String?
  isNieuwbouw        Boolean             @default(false)
  kadasterNumber     String?
  bagId              String?
  propertyType       PropertyType
  bouwjaar           Int?
  woonoppervlakte    Int?
  perceelOppervlakte Int?
  inhoud             Int?
  aantalKamers       Int?
  aantalVerdiepingen Int?
  startDate          DateTime?
  expectedEnd        DateTime?
  currentPhase       ConstructionPhase?
  energielabel       EnergyLabel?
  energielabelDate   DateTime?
  energielabelExpiry DateTime?
  wozWaarde          Decimal?
  wozYear            Int?
  koopsom            Decimal?
  koopDatum          DateTime?
  verificationBadge  Boolean             @default(false)
  cereVaultId        String?
  status             PropertyStatus      @default(ACTIVE)
  ownerId            String
  CostBreakdown      CostBreakdown[]
  Document           Document[]
  MaintenanceRecord  MaintenanceRecord[]
  Project            Project[]
  User               User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  PropertyShare      PropertyShare[]
  TimelineEvent      TimelineEvent[]

  @@index([kadasterNumber])
  @@index([ownerId])
  @@index([postcode])
}

model PropertyShare {
  id             String           @id
  createdAt      DateTime         @default(now())
  expiresAt      DateTime?
  token          String           @unique
  accessLevel    ShareAccessLevel
  allowedEmail   String?
  password       String?
  maxViews       Int?
  viewCount      Int              @default(0)
  showDocuments  Boolean          @default(true)
  showTimeline   Boolean          @default(true)
  showFinancials Boolean          @default(false)
  propertyId     String
  Property       Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([token])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TimelineEvent {
  id          String     @id
  createdAt   DateTime   @default(now())
  occurredAt  DateTime
  type        EventType
  title       String
  description String?
  metadata    Json?
  temperature Float?
  humidity    Float?
  weather     String?
  verified    Boolean    @default(false)
  verifiedBy  String?
  verifiedAt  DateTime?
  contentHash String?
  propertyId  String
  createdById String
  projectId   String?
  Document    Document[]
  User        User       @relation(fields: [createdById], references: [id])
  Project     Project?   @relation(fields: [projectId], references: [id])
  Property    Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([occurredAt])
  @@index([propertyId])
  @@index([type])
}

model User {
  id              String          @id
  email           String          @unique
  password        String?
  name            String?
  emailVerified   DateTime?
  image           String?
  phone           String?
  role            UserRole        @default(HOMEOWNER)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  termsAcceptedAt DateTime?
  companyId       String?
  Account         Account[]
  Document        Document[]
  Property        Property[]
  Session         Session[]
  TimelineEvent   TimelineEvent[]
  Company         Company?        @relation(fields: [companyId], references: [id])
  Notification    Notification[]
}

// ============================================
// In-App Notifications
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  link      String?          // Optional link to navigate to
  metadata  Json?            // Additional data (e.g., project ID, document ID)
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

enum NotificationType {
  DOCUMENT_UPLOADED
  DOCUMENT_VERIFIED
  PHASE_COMPLETED
  PHASE_STARTED
  ISSUE_DETECTED
  ISSUE_RESOLVED
  MESSAGE_RECEIVED
  SHARE_LINK_CREATED
  MILESTONE_REACHED
  MAINTENANCE_DUE
  SYSTEM
}

enum CompanyType {
  GENERAL_CONTRACTOR
  SUBCONTRACTOR
  ARCHITECT
  ENGINEER
  INSPECTOR
  OTHER
}

enum ConstructionPhase {
  GRONDWERK
  FUNDERING
  RUWBOUW
  DAKCONSTRUCTIE
  GEVELWERK
  INSTALLATIES
  AFBOUW
  OPLEVERING
  // Legacy (kept for backward compatibility)
  DAK_GEVEL @map("DAK_GEVEL")
}

enum CostCategory {
  KAVEL
  FOUNDATION
  STRUCTURE
  ROOF_FACADE
  INSTALLATIONS
  FINISHING
  KITCHEN
  BATHROOM
  GARDEN
  FEES
  OTHER
}

enum DocumentSource {
  MANUAL
  WHATSAPP
  SMART_GLASSES
  EMAIL
  API
}

enum DocumentType {
  DEED
  PERMIT
  CONTRACT
  INSURANCE
  FLOOR_PLAN
  TECHNICAL_DRAWING
  SPECIFICATION
  MANUAL
  ENERGY_LABEL
  INSPECTION_REPORT
  WARRANTY
  CERTIFICATE
  PHOTO
  VIDEO
  SMART_GLASSES_CAPTURE
  MATERIAL_SPEC
  COMPLIANCE_REPORT
  HANDOVER_REPORT
  INVOICE
  QUOTE
  NOTE
  OTHER
}

enum EnergyLabel {
  A_PLUS_PLUS_PLUS_PLUS
  A_PLUS_PLUS_PLUS
  A_PLUS_PLUS
  A_PLUS
  A
  B
  C
  D
  E
  F
  G
}

enum EventType {
  CONSTRUCTION_START
  FOUNDATION_START
  FOUNDATION_COMPLETE
  FRAMING_COMPLETE
  ROOFING_START
  ROOFING_COMPLETE
  EXTERIOR_COMPLETE
  WINDOWS_INSTALLED
  ELECTRICAL_COMPLETE
  PLUMBING_COMPLETE
  SYSTEMS_INSTALLED
  INSULATION_COMPLETE
  DRYWALL_COMPLETE
  PAINTING_COMPLETE
  FLOORING_COMPLETE
  INTERIOR_COMPLETE
  FINAL_INSPECTION
  HANDOVER
  PHASE_TRANSITION
  MAINTENANCE_PERFORMED
  INSPECTION_COMPLETED
  REPAIR_COMPLETED
  DOCUMENT_ADDED
  PERMIT_RECEIVED
  CERTIFICATE_ISSUED
  PURCHASE
  SALE
  ENERGY_LABEL_UPDATED
  SOLAR_INSTALLED
  INSULATION_UPGRADED
  RENOVATION_START
  RENOVATION_COMPLETE
  CUSTOM
}

enum MaintenanceCategory {
  DAK
  GEVEL
  KOZIJNEN
  GLAS
  DAKGOTEN
  CV_KETEL
  AIRCO
  VENTILATIE
  SANITAIR
  ELEKTRA
  ZONNEPANELEN
  TUIN
  HEKWERK
  BESTRATING
  SCHOORSTEEEN
  RIOOL
  ALGEMEEN
}

enum MaintenanceStatus {
  SCHEDULED
  OVERDUE
  IN_PROGRESS
  COMPLETED
  CANCELLED
  SKIPPED
}

enum MaterialCategory {
  FOUNDATION
  STRUCTURAL
  ROOFING
  INSULATION
  WINDOWS_DOORS
  ELECTRICAL
  PLUMBING
  HVAC
  FLOORING
  PAINT_COATING
  TILES
  KITCHEN
  BATHROOM
  OTHER
}

enum PhaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum ProjectStatus {
  PLANNING
  PERMIT_PENDING
  APPROVED
  IN_PROGRESS
  ON_HOLD
  INSPECTION
  COMPLETED
  CANCELLED
}

enum ProjectType {
  NEW_CONSTRUCTION
  RENOVATION
  EXTENSION
  MAINTENANCE
  RESTORATION
  DEMOLITION
}

enum PropertyStatus {
  ACTIVE
  UNDER_CONSTRUCTION
  RENOVATION
  FOR_SALE
  SOLD
  ARCHIVED
}

enum PropertyType {
  APPARTEMENT
  TUSSENWONING
  HOEKWONING
  TWEE_ONDER_EEN_KAP
  VRIJSTAAND
  BUNGALOW
  PENTHOUSE
  MAISONNETTE
  WOONBOERDERIJ
  GRACHTENPAND
  HERENHUIS
  VILLA
  STUDIO
  OTHER
}

enum ShareAccessLevel {
  BASIC
  STANDARD
  FULL
  BUYER
}

enum UserRole {
  HOMEOWNER
  BUILDER
  CONTRACTOR
  INSPECTOR
  MUNICIPALITY
  ADMIN
}

// ============================================
// WhatsApp B2B Integration
// ============================================

model WhatsAppNumber {
  id           String    @id @default(cuid())
  phoneNumber  String    @unique // E.164 format: +31612345678
  companyId    String
  projectId    String?   // Optional: link to specific project
  verified     Boolean   @default(false)
  verifiedAt   DateTime?
  verifyCode   String?   // 6-digit verification code
  verifyExpiry DateTime? // Code expiry time
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  company  Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project  Project?          @relation(fields: [projectId], references: [id])
  messages WhatsAppMessage[]

  @@index([companyId])
  @@index([projectId])
}

model WhatsAppMessage {
  id              String           @id @default(cuid())
  twilioMessageId String           @unique // Twilio SID
  fromPhone       String
  toPhone         String
  direction       MessageDirection
  content         String?          // Text content
  mediaUrl        String?          // Original Twilio media URL
  mediaType       String?          // image/jpeg, video/mp4, etc.
  status          MessageStatus    @default(RECEIVED)

  // Link to created document (if media was processed)
  documentId String?
  document   Document? @relation(fields: [documentId], references: [id])

  // Link to sender
  whatsappNumberId String?
  whatsappNumber   WhatsAppNumber? @relation(fields: [whatsappNumberId], references: [id])

  // Link to project (derived from whatsappNumber or explicit)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  metadata    Json?     // Raw Twilio payload
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([fromPhone])
  @@index([projectId])
  @@index([createdAt])
}

model NotificationPreference {
  id        String @id @default(cuid())
  companyId String
  projectId String

  whatsappEnabled Boolean @default(true)
  emailEnabled    Boolean @default(true)

  // What to notify about
  notifyPhaseChange   Boolean @default(true)
  notifyDocumentAdded Boolean @default(false)
  notifyMilestone     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([companyId, projectId])
}

// ============================================
// Issue Tracker
// ============================================

model Issue {
  id          String    @id @default(cuid())
  projectId   String
  documentId  String?   // Source photo that detected the issue
  title       String
  description String?
  severity    String    @default("medium") // low, medium, high, critical
  status      String    @default("open")   // open, in_progress, resolved, dismissed
  assignedTo  String?   // Builder/subcontractor name or ID
  phase       String?   // Construction phase when detected
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  resolvedAt  DateTime?

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id])
  mentions Mention[]

  @@index([projectId])
  @@index([status])
  @@index([severity])
}

// ============================================
// Team Member & Mentions
// ============================================

model TeamMember {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  role        String?  // Metselaar, Elektricien, Timmerman, etc.
  phone       String?  // For WhatsApp notifications (E.164 format)
  email       String?
  specialties String[] // Array of skills/trades
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  mentions Mention[]

  @@index([companyId])
  @@index([role])
  @@index([active])
}

model Mention {
  id           String    @id @default(cuid())
  issueId      String
  teamMemberId String
  notified     Boolean   @default(false)
  notifiedAt   DateTime?
  createdAt    DateTime  @default(now())

  issue      Issue      @relation(fields: [issueId], references: [id], onDelete: Cascade)
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([issueId, teamMemberId])
  @@index([issueId])
  @@index([teamMemberId])
  @@index([notified])
}

enum MessageDirection {
  INCOMING
  OUTGOING
}

enum MessageStatus {
  RECEIVED
  PROCESSING
  PROCESSED
  FAILED
  SENT
  DELIVERED
  READ
}

// ============================================
// Voice Notes
// ============================================

model VoiceNote {
  id            String    @id @default(cuid())
  projectId     String
  documentId    String?   // Link to photo if voice describes a photo
  audioUrl      String    // Stored audio file path
  transcription String?   @db.Text
  duration      Int?      // Duration in seconds
  createdAt     DateTime  @default(now())
  createdBy     String?   // Phone number or user identifier

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id])

  @@index([projectId])
  @@index([createdAt])
}
