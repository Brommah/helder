// Woningpaspoort Database Schema
// Comprehensive housing lifecycle documentation system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// Authentication & Users
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // Hashed password for credentials auth
  name          String?
  emailVerified DateTime?
  image         String?
  phone         String?
  role          UserRole  @default(HOMEOWNER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Terms acceptance (Wkb disclaimer)
  termsAcceptedAt DateTime?

  // Relations
  accounts      Account[]
  sessions      Session[]
  properties    Property[]
  company       Company?   @relation(fields: [companyId], references: [id])
  companyId     String?
  documents     Document[]
  timelineEvents TimelineEvent[]
}

enum UserRole {
  HOMEOWNER
  BUILDER
  CONTRACTOR
  INSPECTOR
  MUNICIPALITY
  ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// Companies (Builders, Contractors)
// ============================================

model Company {
  id            String      @id @default(cuid())
  name          String
  kvkNumber     String?     @unique  // Chamber of Commerce number
  type          CompanyType
  verified      Boolean     @default(false)
  verifiedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Contact
  email         String?
  phone         String?
  address       String?
  postcode      String?
  city          String?

  // Relations
  employees     User[]
  projects      Project[]
  certifications Certification[]
}

enum CompanyType {
  GENERAL_CONTRACTOR  // Hoofdaannemer
  SUBCONTRACTOR       // Onderaannemer
  ARCHITECT
  ENGINEER
  INSPECTOR
  OTHER
}

model Certification {
  id          String   @id @default(cuid())
  name        String
  issuer      String
  issuedAt    DateTime
  expiresAt   DateTime?
  documentUrl String?
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

// ============================================
// Properties (Core Domain)
// ============================================

model Property {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Name (user-defined)
  name            String?           // "Villa Zonneweide"

  // Address (standard format)
  street          String?
  houseNumber     String?
  houseNumberAdd  String?
  postcode        String?
  city            String
  country         String   @default("NL")

  // Kavel address (for nieuwbouw - address may not exist yet)
  kavelNumber     String?           // "Kavel 12"
  projectName     String?           // "Woonwijk De Buitenplaats"
  isNieuwbouw     Boolean  @default(false)

  // Cadastral
  kadasterNumber  String?  // e.g., "ASD01 A 1234"
  bagId           String?  // BAG identification

  // Property Details
  propertyType    PropertyType
  bouwjaar        Int?              // Year built
  woonoppervlakte Int?              // Living area m²
  perceelOppervlakte Int?           // Plot area m²
  inhoud          Int?              // Volume m³
  aantalKamers    Int?              // Number of rooms
  aantalVerdiepingen Int?           // Number of floors

  // Construction Timeline (for nieuwbouw)
  startDate       DateTime?         // Project start
  expectedEnd     DateTime?         // Expected completion
  currentPhase    ConstructionPhase?

  // Energy
  energielabel        EnergyLabel?
  energielabelDate    DateTime?
  energielabelExpiry  DateTime?

  // Valuation
  wozWaarde       Decimal?
  wozYear         Int?
  koopsom         Decimal?          // Purchase price
  koopDatum       DateTime?         // Purchase date

  // Verification badge
  verificationBadge Boolean @default(false)
  cereVaultId       String?

  // Status
  status          PropertyStatus @default(ACTIVE)

  // Ownership
  ownerId         String
  owner           User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Relations
  documents       Document[]
  timeline        TimelineEvent[]
  maintenance     MaintenanceRecord[]
  shares          PropertyShare[]
  projects        Project[]
  costs           CostBreakdown[]

  @@index([ownerId])
  @@index([postcode])
  @@index([kadasterNumber])
}

enum PropertyType {
  APPARTEMENT
  TUSSENWONING
  HOEKWONING
  TWEE_ONDER_EEN_KAP
  VRIJSTAAND
  BUNGALOW
  PENTHOUSE
  MAISONNETTE
  WOONBOERDERIJ
  GRACHTENPAND
  HERENHUIS
  VILLA
  STUDIO
  OTHER
}

enum PropertyStatus {
  ACTIVE
  UNDER_CONSTRUCTION
  RENOVATION
  FOR_SALE
  SOLD
  ARCHIVED
}

enum ConstructionPhase {
  GRONDWERK      // Foundation work
  RUWBOUW        // Shell/structure
  DAK_GEVEL      // Roof & facade
  INSTALLATIES   // Installations (E/W/HVAC)
  AFBOUW         // Finishing
  OPLEVERING     // Handover
}

// ============================================
// Cost Breakdown (Budget vs Actuals)
// ============================================

model CostBreakdown {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category    CostCategory
  description String?
  budgeted    Decimal
  actual      Decimal  @default(0)

  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, category])
  @@index([propertyId])
}

enum CostCategory {
  KAVEL           // Plot/land
  FOUNDATION      // Fundering
  STRUCTURE       // Ruwbouw
  ROOF_FACADE     // Dak & gevel
  INSTALLATIONS   // Installaties
  FINISHING       // Afbouw
  KITCHEN         // Keuken
  BATHROOM        // Badkamer
  GARDEN          // Tuin
  FEES            // Leges, notaris, etc.
  OTHER           // Overig
}

enum EnergyLabel {
  A_PLUS_PLUS_PLUS_PLUS  // A++++
  A_PLUS_PLUS_PLUS       // A+++
  A_PLUS_PLUS            // A++
  A_PLUS                 // A+
  A
  B
  C
  D
  E
  F
  G
}

// ============================================
// Timeline (Immutable Event Log)
// ============================================

model TimelineEvent {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  occurredAt  DateTime  // When the event actually happened
  
  // Event Details
  type        EventType
  title       String
  description String?   @db.Text
  
  // Metadata
  metadata    Json?     // Flexible field for event-specific data
  
  // Weather (for construction events)
  temperature Float?
  humidity    Float?
  weather     String?   // "sunny", "rainy", etc.
  
  // Verification
  verified    Boolean   @default(false)
  verifiedBy  String?
  verifiedAt  DateTime?
  
  // Hash for immutability (future: blockchain)
  contentHash String?
  
  // Relations
  propertyId  String
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])
  
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id])
  
  documents   Document[]

  @@index([propertyId])
  @@index([type])
  @@index([occurredAt])
}

enum EventType {
  // Construction
  CONSTRUCTION_START
  FOUNDATION_COMPLETE
  FRAMING_COMPLETE
  ROOFING_COMPLETE
  ELECTRICAL_COMPLETE
  PLUMBING_COMPLETE
  INSULATION_COMPLETE
  DRYWALL_COMPLETE
  PAINTING_COMPLETE
  FLOORING_COMPLETE
  FINAL_INSPECTION
  HANDOVER             // Oplevering
  
  // Maintenance
  MAINTENANCE_PERFORMED
  INSPECTION_COMPLETED
  REPAIR_COMPLETED
  
  // Documents
  DOCUMENT_ADDED
  PERMIT_RECEIVED
  CERTIFICATE_ISSUED
  
  // Ownership
  PURCHASE
  SALE
  
  // Energy
  ENERGY_LABEL_UPDATED
  SOLAR_INSTALLED
  INSULATION_UPGRADED
  
  // Other
  RENOVATION_START
  RENOVATION_COMPLETE
  CUSTOM
}

// ============================================
// Construction Projects
// ============================================

model Project {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Basic Info
  name        String
  description String?   @db.Text
  type        ProjectType
  status      ProjectStatus @default(PLANNING)
  
  // Timeline
  plannedStart  DateTime?
  plannedEnd    DateTime?
  actualStart   DateTime?
  actualEnd     DateTime?
  
  // Budget
  estimatedCost Decimal?
  actualCost    Decimal?
  
  // Wkb Compliance
  wkbRequired     Boolean  @default(false)
  wkbDossierId    String?  // External compliance system ID
  
  // Relations
  propertyId    String
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id])
  
  phases        ProjectPhase[]
  documents     Document[]
  contractors   ProjectContractor[]
  materials     MaterialUsage[]
  timeline      TimelineEvent[]
  
  @@index([propertyId])
  @@index([companyId])
  @@index([status])
}

enum ProjectType {
  NEW_CONSTRUCTION  // Nieuwbouw
  RENOVATION        // Verbouwing
  EXTENSION         // Uitbouw/aanbouw
  MAINTENANCE       // Onderhoud
  RESTORATION       // Restauratie
  DEMOLITION        // Sloop
}

enum ProjectStatus {
  PLANNING
  PERMIT_PENDING
  APPROVED
  IN_PROGRESS
  ON_HOLD
  INSPECTION
  COMPLETED
  CANCELLED
}

model ProjectPhase {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  name        String
  description String?
  order       Int
  status      PhaseStatus @default(PENDING)
  
  plannedStart  DateTime?
  plannedEnd    DateTime?
  actualStart   DateTime?
  actualEnd     DateTime?
  
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  documents   Document[]
  
  @@index([projectId])
}

enum PhaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

model ProjectContractor {
  id          String    @id @default(cuid())
  
  role        String    // e.g., "Electrician", "Plumber"
  startDate   DateTime?
  endDate     DateTime?
  
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Either linked company or external
  companyId   String?
  companyName String?   // For external contractors not in system
  contactInfo String?
  
  @@index([projectId])
}

// ============================================
// Materials & Specifications
// ============================================

model MaterialUsage {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  
  // Material Info
  category    MaterialCategory
  name        String
  brand       String?
  productCode String?
  color       String?
  
  // Specifications
  quantity    Decimal?
  unit        String?   // "m²", "liters", "pieces"
  batchNumber String?
  
  // Application
  appliedAt   DateTime?
  appliedBy   String?   // Contractor name
  location    String?   // Where in the property
  
  // Documentation
  specSheetUrl  String?
  warrantyUrl   String?
  warrantyExpires DateTime?
  
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
  @@index([category])
}

enum MaterialCategory {
  FOUNDATION
  STRUCTURAL
  ROOFING
  INSULATION
  WINDOWS_DOORS
  ELECTRICAL
  PLUMBING
  HVAC
  FLOORING
  PAINT_COATING
  TILES
  KITCHEN
  BATHROOM
  OTHER
}

// ============================================
// Documents
// ============================================

model Document {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // File Info
  name        String
  description String?
  type        DocumentType
  mimeType    String
  fileSize    Int
  fileUrl     String
  
  // Metadata
  documentDate DateTime?  // Date on the document itself
  expiresAt    DateTime?
  
  // Verification
  verified    Boolean   @default(false)
  verifiedBy  String?
  
  // Auto-extraction
  extractedData Json?    // AI-extracted metadata
  
  // Relations
  propertyId  String?
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  phaseId     String?
  phase       ProjectPhase? @relation(fields: [phaseId], references: [id])
  
  timelineEventId String?
  timelineEvent   TimelineEvent? @relation(fields: [timelineEventId], references: [id])
  
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  
  @@index([propertyId])
  @@index([projectId])
  @@index([type])
}

enum DocumentType {
  // Legal
  DEED                 // Akte
  PERMIT               // Vergunning
  CONTRACT             // Contract
  INSURANCE            // Verzekering
  
  // Technical
  FLOOR_PLAN           // Plattegrond
  TECHNICAL_DRAWING    // Technische tekening
  SPECIFICATION        // Specificatie
  MANUAL               // Handleiding
  
  // Certificates
  ENERGY_LABEL
  INSPECTION_REPORT    // Keuringsrapport
  WARRANTY             // Garantie
  CERTIFICATE
  
  // Media
  PHOTO
  VIDEO
  SMART_GLASSES_CAPTURE
  
  // Construction
  MATERIAL_SPEC
  COMPLIANCE_REPORT    // Wkb rapport
  HANDOVER_REPORT      // Opleveringsrapport
  
  // Financial
  INVOICE
  QUOTE                // Offerte
  
  // Other
  NOTE
  OTHER
}

// ============================================
// Maintenance
// ============================================

model MaintenanceRecord {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  title       String
  description String?   @db.Text
  category    MaintenanceCategory
  
  // Scheduling
  performedAt   DateTime?
  scheduledFor  DateTime?
  nextDueDate   DateTime?
  intervalMonths Int?     // Recurring interval
  
  // Execution
  performedBy String?
  cost        Decimal?
  
  // Status
  status      MaintenanceStatus @default(SCHEDULED)
  
  propertyId  String
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@index([propertyId])
  @@index([category])
  @@index([nextDueDate])
}

enum MaintenanceCategory {
  DAK               // Roof
  GEVEL             // Facade
  KOZIJNEN          // Window frames
  GLAS              // Glass/windows
  DAKGOTEN          // Gutters
  CV_KETEL          // Heating system
  AIRCO             // Air conditioning
  VENTILATIE        // Ventilation
  SANITAIR          // Plumbing
  ELEKTRA           // Electrical
  ZONNEPANELEN      // Solar panels
  TUIN              // Garden
  HEKWERK           // Fencing
  BESTRATING        // Paving
  SCHOORSTEEEN      // Chimney
  RIOOL             // Sewage
  ALGEMEEN          // General
}

enum MaintenanceStatus {
  SCHEDULED
  OVERDUE
  IN_PROGRESS
  COMPLETED
  CANCELLED
  SKIPPED
}

// ============================================
// Sharing
// ============================================

model PropertyShare {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  
  token       String    @unique
  accessLevel ShareAccessLevel
  
  // Optional restrictions
  allowedEmail  String?
  password      String?  // Hashed
  maxViews      Int?
  viewCount     Int      @default(0)
  
  // What to show
  showDocuments Boolean  @default(true)
  showTimeline  Boolean  @default(true)
  showFinancials Boolean @default(false)
  
  propertyId  String
  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([propertyId])
}

enum ShareAccessLevel {
  BASIC         // Address, type, size only
  STANDARD      // + energy label, year built
  FULL          // + all documents and timeline
  BUYER         // Full + financial info
}
